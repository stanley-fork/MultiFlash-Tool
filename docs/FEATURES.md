# MultiFlash Tool 功能详解

> 本文档详细介绍 MultiFlash Tool v2.0 的所有功能

---

## 目录

- [OFP/OZIP/OPS 固件解密](#ofpozipos-固件解密)
- [智能刷机服务](#智能刷机服务)
- [设备信息读取](#设备信息读取)
- [认证策略系统](#认证策略系统)
- [分区管理与风险提示](#分区管理与风险提示)
- [Firehose 协议增强](#firehose-协议增强)
- [Sahara 协议支持](#sahara-协议支持)
- [镜像处理工具](#镜像处理工具)

---

## OFP/OZIP/OPS 固件解密

### 支持的固件格式

| 格式 | 厂商 | 加密方式 | 芯片平台 |
|------|------|----------|----------|
| `.ofp` | OPPO/Realme | AES-128-CFB | Qualcomm/MTK |
| `.ozip` | OPPO | AES-128-ECB | 通用 |
| `.ops` | OnePlus | AES-128-ECB | Qualcomm |

### 解密流程

```
1. 检测固件类型 (OFP/OZIP/OPS)
2. 检测芯片类型 (Qualcomm/MTK)
3. 尝试已知密钥列表 (50+ 组)
4. 若失败，启动智能爆破
5. 解密并解压固件内容
6. 解析 rawprogram*.xml
```

### 密钥爆破模式

当标准密钥无法解密时，程序会启动多阶段爆破：

| 阶段 | 方法 | 密钥数量 |
|------|------|----------|
| 阶段1 | 已知模板变体 | ~12,000 |
| 阶段2 | 简单密钥变体 | ~2,000 |
| 阶段3 | 增量字节爆破 | ~5,000 |
| 阶段4 | 随机密钥 | 可配置 |

### 使用方法

1. 点击 **"选择固件"** 按钮
2. 选择 `.ofp`、`.ozip` 或 `.ops` 文件
3. 程序自动检测类型并解密
4. 解密成功后自动加载分区表

### 已知限制

- 2024 年之后的新固件可能使用未知密钥
- MTK 固件需要正确的 Shuffle 算法
- 部分固件可能有额外的加密层

---

## 智能刷机服务

### 工作流程

```
┌─────────────────┐
│  连接设备 (EDL) │
└────────┬────────┘
         ▼
┌─────────────────┐
│  Sahara 握手    │ ← 读取设备信息
└────────┬────────┘   (Serial, HWID, PK Hash)
         ▼
┌─────────────────┐
│  加载 Loader    │ ← 自动匹配或用户选择
└────────┬────────┘
         ▼
┌─────────────────┐
│  Firehose 配置  │ ← 自动检测 UFS/eMMC
└────────┬────────┘
         ▼
┌─────────────────┐
│  读取分区表     │ ← 自动读取 GPT
└────────┬────────┘
         ▼
┌─────────────────┐
│  验证分区       │ ← 检查镜像完整性
└────────┬────────┘
         ▼
┌─────────────────┐
│  写入分区       │ ← 进度实时显示
└────────┬────────┘
         ▼
┌─────────────────┐
│  应用补丁       │ ← patch*.xml
└────────┬────────┘
         ▼
┌─────────────────┐
│  重启设备       │
└─────────────────┘
```

### 自动 Loader 匹配

程序会根据以下信息匹配 Loader：
- MSM Hardware ID
- PK Hash (Sahara V2)
- 设备型号

如果无法自动匹配，程序会：
1. 显示设备信息
2. 提供推荐的 Loader 文件名
3. 等待用户手动选择

### 存储类型检测

自动检测并配置：
- **eMMC**: 512 字节扇区
- **UFS**: 4096 字节扇区
- **NAND**: 根据设备响应调整

---

## 设备信息读取

### 读取来源

从以下分区读取 `build.prop`：

| 优先级 | 分区 | 说明 |
|--------|------|------|
| 1 | super | Android 10+ 动态分区容器 |
| 2 | system | 传统系统分区 |
| 3 | vendor | 厂商分区 |

### 支持的文件系统

- **EXT4** - 标准 Android 文件系统
- **EROFS** - 只读压缩文件系统 (Android 12+)
- **F2FS** - 闪存友好文件系统
- **SquashFS** - 压缩只读文件系统

### 显示信息

| 属性 | 来源 |
|------|------|
| 设备型号 | `ro.product.model` |
| 厂商 | `ro.product.brand` |
| Android 版本 | `ro.build.version.release` |
| SDK 版本 | `ro.build.version.sdk` |
| 安全补丁 | `ro.build.version.security_patch` |
| 构建指纹 | `ro.build.fingerprint` |

---

## 认证策略系统

### 三种认证模式

#### 标准模式 (Standard)

默认模式，适用于大多数设备：
- 无特殊认证
- 直接配置 Firehose
- 自动检测小米设备

#### VIP 模式 (OPPO VIP)

专为 OPPO/Realme 设备设计：
- 特殊 RW 模式检测
- 智能策略选择
- Gap 自动检测
- 分段读取优化

支持的 RW 模式：
- `GptBackup` - GPT 备份模式
- `GptMain_Mode1` - GPT 主模式 1
- `GptMain_Mode2` - GPT 主模式 2
- `Normal` - 正常模式

#### 小米模式 (Xiaomi MiAuth)

专为小米/红米设备设计：
- 内置 5 组签名盲测
- Blob 获取和手动签名
- 支持 Demacia/SwProject/Project 协议

认证流程：
```
1. Ping 设备
2. 盲测 5 组内置签名
3. 若失败，获取 Blob
4. 提示用户手动签名
5. 发送签名完成认证
```

---

## 分区管理与风险提示

### 分区风险等级

| 等级 | 颜色 | 分区示例 | 说明 |
|------|------|----------|------|
| 关键 | 🔴 红色 | xbl, abl, aop, tz, hyp | 操作可能变砖 |
| 危险 | 🟠 橙色 | boot, recovery, vbmeta | 影响启动 |
| 重要 | 🟡 黄色 | modem, dsp, bluetooth | 影响功能 |
| 系统 | 🟣 紫色 | system, vendor, odm | 系统分区 |
| 数据 | 🟢 绿色 | userdata, cache | 用户数据 |
| GPT | 🔵 蓝色 | gpt_main, gpt_backup | 分区表 |
| 普通 | ⚪ 白色 | 其他 | 一般分区 |

### 分区列表显示

| 列 | 说明 |
|----|------|
| ☑️ | 选择框 |
| Name | 分区名称 |
| Start | 起始扇区 |
| Size | 分区大小 |
| Attr | 分区属性 |
| FS | 文件系统类型 |
| Fmt | 镜像格式 (Raw/Sparse) |
| File | 关联镜像文件 |

---

## Firehose 协议增强

### 新增功能

- **智能存储检测**: 自动识别 eMMC/UFS/NAND
- **扇区大小适配**: 512/4096 自动切换
- **高速并行读写**: 多 LUN 并行操作
- **失败自动重试**: 可配置重试次数
- **详细响应解析**: 完整的 XML 响应日志

### 支持的命令

| 命令 | 功能 |
|------|------|
| `configure` | 配置 Firehose |
| `program` | 写入分区 |
| `read` | 读取分区 |
| `erase` | 擦除分区 |
| `patch` | 应用补丁 |
| `getgpt` | 获取 GPT |
| `setbootablestoragedrive` | 设置启动驱动器 |
| `reset` | 重启设备 |

---

## Sahara 协议支持

### 协议版本

| 版本 | 特性 |
|------|------|
| V2 | 完整设备信息 (Serial, HWID, PK Hash) |
| V3 | 有限设备信息 (无 PK Hash) |

### 智能握手流程

```
1. 等待 Hello 包
2. 发送 Hello Response
3. 读取设备信息
4. 检测协议版本
5. 匹配或选择 Loader
6. 发送 Loader
7. 等待 End of Image
8. 进入 Firehose 模式
```

### 安全退出

如果无法找到合适的 Loader：
- 安全退出 Sahara 模式
- 显示设备信息
- 提供用户指引
- 避免设备卡死

---

## 镜像处理工具

### Sparse 镜像处理

- **检测**: 自动识别 Raw/Sparse 格式
- **转换**: Sparse → Raw, Raw → Sparse
- **分割**: 大镜像分割为多个部分
- **合并**: 多个 Sparse 镜像合并

### 文件系统检测

从镜像中检测文件系统类型：

| 魔数偏移 | 魔数值 | 文件系统 |
|----------|--------|----------|
| 0x438 | 0xEF53 | EXT4 |
| 0x400 | 0xF2F52010 | F2FS |
| 0x0 | 0xE2E1F5E0 | EROFS |
| 0x0 | 0x73717368 | SquashFS |

---

## 日志系统

### 日志级别

| 级别 | 颜色 | 用途 |
|------|------|------|
| INFO | 黑色 | 一般信息 |
| SUCCESS | 绿色 | 成功操作 |
| WARNING | 橙色 | 警告信息 |
| ERROR | 红色 | 错误信息 |

### 格式化输出

```
14:20:04 ▶️ 加载 OFP 固件包
14:20:04 • 文件 : firmware.ofp
14:20:04 • 大小 : 4.2 GB
14:20:04 [OFP] 芯片类型: Qualcomm
14:20:04 [OFP] 页面大小: 4096 字节
14:20:05 ✅ 解密成功
```

---

<div align="center">

**MultiFlash Tool v2.0**

[返回主页](../README.md) | [开发文档](../DEVELOPMENT.md) | [更新日志](../CHANGELOG.md)

</div>
